// --- è¨­å®š ---
// å‡ºé‡‘é‡‘é¡ï¼ˆå††ï¼‰ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆAåˆ—ãŒ0ã€Båˆ—ãŒ1...ï¼‰
// CSVã®Båˆ— -> ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 1
const AMOUNT_COLUMN_INDEX = 1; 

// å–å¼•æ–¹æ³•ï¼ˆå†…è¨³ï¼‰ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆAåˆ—ãŒ0ã€Båˆ—ãŒ1...ï¼‰
// CSVã®Jåˆ— -> ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 9
const DESCRIPTION_COLUMN_INDEX = 9; 

// ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ•°
const HEADER_ROWS_TO_SKIP = 1; 

/**
 * é‡‘é¡æ–‡å­—åˆ—ï¼ˆ"1,000" ã‚„ 1000ï¼‰ã‚’æ•°å€¤ï¼ˆ1000ï¼‰ã«å¤‰æ›ã™ã‚‹
 */
function parseAmount(amountValue) {
  if (typeof amountValue === 'number') {
    return amountValue; // æ—¢ã«æ•°å€¤ãªã‚‰ãã®ã¾ã¾
  }
  if (!amountValue) {
    return 0; // Nullã¾ãŸã¯ç©ºæ¬„ãªã‚‰0
  }
  // é«˜é€ŸåŒ–ã®ãŸã‚ã€æ­£è¦è¡¨ç¾ã‚’ã‚·ãƒ³ãƒ—ãƒ«ãªæ–‡å­—åˆ—ç½®æ›ã«å¤‰æ›´
  let amountString = String(amountValue).trim(); 
  if (amountString === "-") {
    return 0;
  }
  amountString = amountString.replace(/,/g, '').replace(/"/g, ''); // ã‚«ãƒ³ãƒã¨"ã‚’é™¤å»

  const num = parseFloat(amountString);
  return isNaN(num) ? 0 : num;
}

/**
 * PayPayå±¥æ­´ã®ä½µç”¨æ‰•ã„è¡Œã‚’ã€æ®‹é«˜åˆ©ç”¨è¡Œã¨ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨è¡Œã«åˆ†å‰²ã™ã‚‹
 * é«˜é€ŸåŒ–ã®ãŸã‚ã€Array.prototype.flatMap() ã‚’ä½¿ç”¨
 */
function splitPayPayTransaction() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();
  
  const range = sheet.getDataRange();
  const values = range.getValues();
  
  if (values.length <= HEADER_ROWS_TO_SKIP) {
    Browser.msgBox('ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', Browser.Buttons.OK);
    return;
  }
  
  const headerRows = values.slice(0, HEADER_ROWS_TO_SKIP);
  const dataRows = values.slice(HEADER_ROWS_TO_SKIP);
  
  // --- ğŸš€ é«˜é€ŸåŒ–å‡¦ç† (flatMap) ---
  const processedData = dataRows.flatMap(row => {
    const description = String(row[DESCRIPTION_COLUMN_INDEX]);
    
    // 1. ä½µç”¨æ‰•ã„ã‹ãƒã‚§ãƒƒã‚¯
    if (description.includes("PayPayæ®‹é«˜ (") && description.includes("PayPayãƒã‚¤ãƒ³ãƒˆ (")) {
      const originalAmountText = row[AMOUNT_COLUMN_INDEX];
      const originalAmount = parseAmount(originalAmountText);

      const balanceMatch = description.match(/PayPayæ®‹é«˜ \(([0-9,]+)å††\)/);
      const pointMatch = description.match(/PayPayãƒã‚¤ãƒ³ãƒˆ \(([0-9,]+)å††\)/);
      
      if (balanceMatch && pointMatch) {
        const balanceAmount = parseAmount(balanceMatch[1]);
        const pointAmount = parseAmount(pointMatch[1]);
        
        // é‡‘é¡ãƒã‚§ãƒƒã‚¯
        if (Math.round((balanceAmount + pointAmount) * 100) / 100 !== originalAmount) {
          // é‡‘é¡ãŒä¸€è‡´ã—ãªã„å ´åˆã¯ã€åˆ†å‰²ã›ãšå…ƒã®è¡Œã‚’ãã®ã¾ã¾è¿”ã™
          return [row]; 
        }

        // 2. æ®‹é«˜è¡Œã¨ãƒã‚¤ãƒ³ãƒˆè¡Œã®2è¡Œã‚’ç”Ÿæˆã—ã¦è¿”ã™
        let balanceRow = [...row];
        balanceRow[AMOUNT_COLUMN_INDEX] = balanceAmount;
        balanceRow[DESCRIPTION_COLUMN_INDEX] = "PayPayæ®‹é«˜åˆ©ç”¨";
        
        let pointRow = [...row];
        pointRow[AMOUNT_COLUMN_INDEX] = pointAmount;
        pointRow[DESCRIPTION_COLUMN_INDEX] = "PayPayãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨";
        
        return [balanceRow, pointRow]; // 1è¡ŒãŒ2è¡Œã«ãªã‚‹
        
      } else {
        // æ­£è¦è¡¨ç¾ã«ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆï¼ˆã‚ã‚Šå¾—ãªã„ãŒå®‰å…¨ã®ãŸã‚ï¼‰
        return [row]; // å…ƒã®è¡Œã‚’ãã®ã¾ã¾è¿”ã™
      }
      
    } else {
      // ä½µç”¨æ‰•ã„ã§ã¯ãªã„è¡Œ
      return [row]; // å…ƒã®è¡Œã‚’ãã®ã¾ã¾è¿”ã™
    }
  });
  // ------------------------------
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
  const finalValues = headerRows.concat(processedData);
  
  // --- 4. æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãæˆ»ã™ ---
  sheet.clearContents();
  sheet.getRange(1, 1, finalValues.length, finalValues[0].length).setValues(finalValues);
  
  Browser.msgBox('âœ… å‡¦ç†å®Œäº†ï¼ˆé«˜é€ŸåŒ–ï¼‰', `PayPayå±¥æ­´ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`, Browser.Buttons.OK);
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’è¿½åŠ ã™ã‚‹
 */
function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('PayPayå±¥æ­´')
      .addItem('ä½µç”¨æ‰•ã„è¡Œã‚’åˆ†å‰²ãƒ»ä¿®æ­£', 'splitPayPayTransaction')
      .addToUi();
}