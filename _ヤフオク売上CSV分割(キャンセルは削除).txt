// --- è¨­å®š ---
const HEADER_ROWS_TO_SKIP = 1; 

// --- åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©ï¼ˆAåˆ—=0, Båˆ—=1...ï¼‰---
const TRANSACTION_DATE_COL = 0; // å–æ‰±æ—¥ (Aåˆ—)
const PRODUCT_ID_COL = 3;       // å•†å“ID (Dåˆ—)
const PRODUCT_NAME_COL = 4;     // å•†å“å (Eåˆ—)
const SALES_AMOUNT_COL = 7;     // è½æœ­è€…/è³¼å…¥è€…ã®æ”¯æ‰•é‡‘é¡ (Håˆ—) - å£²ä¸Š
const AUCTION_FEE_COL = 8;      // Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ è½æœ­ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ–™ (Iåˆ—) - çµŒè²»
const FLEA_MARKET_FEE_COL = 9;  // Yahoo!ãƒ•ãƒªãƒ è²©å£²æ‰‹æ•°æ–™ (Jåˆ—) - çµŒè²»
const SHIPPING_COL = 10;        // é€æ–™ (Kåˆ—) - çµŒè²»
const STATE_COL = 11;           // çŠ¶æ…‹ (Låˆ—)

/**
 * é‡‘é¡å€¤ï¼ˆæ–‡å­—åˆ—ã¾ãŸã¯æ•°å€¤ï¼‰ã‚’ç¢ºå®Ÿã«æ•°å€¤ï¼ˆNumberï¼‰ã«å¤‰æ›ã™ã‚‹
 */
function parseAmount(amountValue) {
  if (typeof amountValue === 'number') {
    return amountValue; // æ—¢ã«æ•°å€¤ãªã‚‰ãã®ã¾ã¾
  }
  if (!amountValue) {
    return 0; // Nullã¾ãŸã¯ç©ºæ¬„ãªã‚‰0
  }
  // é«˜é€ŸåŒ–ã®ãŸã‚ã€æ­£è¦è¡¨ç¾ã‚’ã‚·ãƒ³ãƒ—ãƒ«ãªæ–‡å­—åˆ—ç½®æ›ã«å¤‰æ›´
  let amountString = String(amountValue).trim(); 
  if (amountString === "-") {
    return 0;
  }
  amountString = amountString.replace(/,/g, '').replace(/"/g, ''); // ã‚«ãƒ³ãƒã¨"ã‚’é™¤å»

  const num = parseFloat(amountString);
  return isNaN(num) ? 0 : num;
}

/**
 * ãƒ¤ãƒ•ã‚ªã‚¯/ãƒ•ãƒªãƒã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒãƒ•ã‚©å–è¾¼ç”¨ã«åˆ†å‰²å‡¦ç†ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * é«˜é€ŸåŒ–ã®ãŸã‚ã€Array.prototype.flatMap() ã‚’ä½¿ç”¨
 */
function splitYahooSalesData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sourceSheet = ss.getActiveSheet(); 
  
  const values = sourceSheet.getDataRange().getValues();
  
  if (values.length <= HEADER_ROWS_TO_SKIP) {
    Browser.msgBox('ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', Browser.Buttons.OK);
    return;
  }
  
  // ãƒãƒãƒ•ã‚©å–è¾¼ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å®šç¾©
  const outputHeader = ["å–å¼•æ—¥", "å•†å“ID", "å•†å“å", "å†…å®¹ï¼ˆå‹˜å®šç§‘ç›®ï¼‰", "é‡‘é¡"];
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ã„ãŸãƒ‡ãƒ¼ã‚¿è¡Œã‚’å–å¾—
  const dataRows = values.slice(HEADER_ROWS_TO_SKIP);
  
  // --- ğŸš€ é«˜é€ŸåŒ–å‡¦ç† (flatMap) ---
  // dataRows ã‚’ä¸€åº¦ã®æ“ä½œã§ã€Œãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã¨ã€Œå¤‰æ›ï¼ˆ1è¡Œ->è¤‡æ•°è¡Œï¼‰ã€ã‚’è¡Œã†
  const processedData = dataRows.flatMap(row => {
    
    // 1. ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¡Œã‚’é™¤å¤–ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
    const status = String(row[STATE_COL]).trim();
    if (status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") || status.includes("å‰Šé™¤")) { 
      return []; // ã“ã®è¡Œã‹ã‚‰ã¯ä½•ã‚‚å‡ºåŠ›ã—ãªã„ï¼ˆï¼é™¤å¤–ï¼‰
    }
    
    // 2. è¡Œã‚’å¤‰æ›ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
    const transactionDate = row[TRANSACTION_DATE_COL];
    const productId = row[PRODUCT_ID_COL];
    const productName = row[PRODUCT_NAME_COL];
    
    const salesAmount = parseAmount(row[SALES_AMOUNT_COL]);
    const shippingCost = parseAmount(row[SHIPPING_COL]);
    const auctionFee = parseAmount(row[AUCTION_FEE_COL]);
    const fleaMarketFee = parseAmount(row[FLEA_MARKET_FEE_COL]);
    
    const resultRows = []; // ã“ã®1è¡Œã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹è¤‡æ•°è¡Œã‚’æ ¼ç´
    
    if (salesAmount > 0) {
      resultRows.push([transactionDate, productId, productName, "å£²ä¸Šé«˜", salesAmount]);
    }
    if (shippingCost > 0) {
      resultRows.push([transactionDate, productId, productName, "è·é€ é‹è³ƒ", -shippingCost]);
    }
    if (auctionFee > 0) {
      resultRows.push([transactionDate, productId, productName, "æ”¯æ‰•æ‰‹æ•°æ–™(ãƒ¤ãƒ•ã‚ªã‚¯)", -auctionFee]);
    }
    if (fleaMarketFee > 0) {
      resultRows.push([transactionDate, productId, productName, "æ”¯æ‰•æ‰‹æ•°æ–™(ãƒ•ãƒªãƒ)", -fleaMarketFee]);
    }
    
    return resultRows; // ä¾‹: [ [å£²ä¸Šè¡Œ], [é€æ–™è¡Œ], [æ‰‹æ•°æ–™è¡Œ] ]
  });
  // ------------------------------
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
  const finalOutput = [outputHeader].concat(processedData);

  // --- çµæœã‚’æ–°ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€ ---
  const outputSheetName = "ãƒãƒãƒ•ã‚©å–è¾¼ç”¨";
  let outputSheet = ss.getSheetByName(outputSheetName);
  
  if (outputSheet) {
    outputSheet.clear();
  } else {
    outputSheet = ss.insertSheet(outputSheetName, 0);
  }
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æ›¸ãè¾¼ã¿
  outputSheet.getRange(1, 1, finalOutput.length, finalOutput[0].length).setValues(finalOutput);
  
  // ğŸš¨ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆé˜²æ­¢ã®ãŸã‚ã€åˆ—å¹…ã®è‡ªå‹•èª¿æ•´ï¼ˆautoResizeColumnsï¼‰ã¯å‰Šé™¤ã—ã¾ã—ãŸ
  
  Browser.msgBox('âœ… å‡¦ç†å®Œäº†ï¼ˆé«˜é€ŸåŒ–ï¼‰', `ã€Œ${outputSheetName}ã€ã‚·ãƒ¼ãƒˆã« ${finalOutput.length - 1} è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦å‡ºåŠ›ã—ã¾ã—ãŸã€‚`, Browser.Buttons.OK);
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’è¿½åŠ ã™ã‚‹
 */
function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('ãƒ¤ãƒ•ã‚ªã‚¯å‡¦ç†')
      .addItem('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒãƒ•ã‚©ç”¨ã«åˆ†å‰²', 'splitYahooSalesData')
      .addToUi();
}